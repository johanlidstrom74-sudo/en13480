<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EN 13480-3 – Godstjocklek för rör (P235GH)</title>
  <style>
    :root{
      --bg1:#f1f5f9; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --line:#e2e8f0; --accent:#0ea5e9; --ok:#15803d; --warn:#b45309; --err:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg,var(--bg1),var(--bg2) 120px);
    }
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 6px;font-size:28px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .card-header{padding:12px 16px;border-bottom:1px solid var(--line)}
    .card-header h2{margin:0;font-size:18px}
    .card-body{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input[type="text"], input[type="number"], select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--text);
      font-size:14px;
    }
    input[disabled], select[disabled]{background:#f8fafc;color:#64748b}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .small{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;background:#eef2ff;color:#334155;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
    .kpi{font-size:22px;font-weight:700}
    .warn{color:var(--warn)} .err{color:var(--err)} .ok{color:var(--ok)}
    .btn{display:inline-block;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .spacer{height:8px}
    .note{padding:8px 10px;border-radius:12px;border:1px dashed var(--line);background:#fafafa}
    .hr{height:1px;background:var(--line);margin:8px 0}
    .error-banner{padding:10px 12px;border:1px solid #fecaca;background:#fff1f2;color:#991b1b;border-radius:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>EN 13480-3 – Godstjocklek för rör</h1>
    <div class="muted">Tryck i <b>bar</b>. P235GH enligt angivna tabeller. Säkerhetsfaktorer 1,5/2,4 tills överstyrning aktiveras.</div>
    <div class="spacer"></div>

    <div class="grid grid-2">
      <div class="card">
        <div class="card-header"><h2>Indata</h2></div>
        <div class="card-body grid">
          <div class="row">
            <div>
              <label for="pressure">Designtryck (bar)</label>
              <input id="pressure" type="text" placeholder="t.ex. 40">
            </div>
            <div>
              <label for="Do">Ytterdiameter Do (mm)</label>
              <input id="Do" type="text" placeholder="t.ex. 219.1">
            </div>
          </div>

          <div class="row">
            <div>
              <label for="std">Materialstandard</label>
              <select id="std">
                <option value="EN 10216-2">EN 10216-2 (sömlös)</option>
                <option value="EN 10217-2">EN 10217-2 (svetsad)</option>
                <option value="EN 10217-5">EN 10217-5 (SAW)</option>
              </select>
            </div>
            <div>
              <label for="mat">Material</label>
              <select id="mat">
                <option value="P235GH">P235GH</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="T">Beräkningstemperatur T (°C)</label>
              <input id="T" type="text" placeholder="t.ex. 150" value="150">
            </div>
            <div>
              <label for="z">Svetsfaktor z (0–1)</label>
              <input id="z" type="text" placeholder="t.ex. 1.0" value="1.0">
            </div>
          </div>

          <div class="row">
            <div>
              <label for="c">Korrosionstillägg c (mm)</label>
              <input id="c" type="text" placeholder="0" value="0">
            </div>
            <div>
              <label for="a">Minus-tolerans α (%)</label>
              <input id="a" type="text" placeholder="0" value="0">
            </div>
          </div>

          <div class="note">
            <label><input type="checkbox" id="ovr"> Tillåt manuell överstyrning av Re(T) och Rm,RT</label>
            <div class="row" id="ovrRow" style="display:none;margin-top:8px">
              <div>
                <label for="ReT">Re(T) manuell (MPa)</label>
                <input id="ReT" type="text" placeholder="t.ex. 205">
              </div>
              <div>
                <label for="RmRT">Rm,RT manuell (MPa)</label>
                <input id="RmRT" type="text" placeholder="t.ex. 360">
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Resultat</h2></div>
        <div class="card-body grid" id="result">
          <div class="small">Fyll i alla nödvändiga fält med giltiga värden.</div>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="card-header"><h2>Säkerhetsfaktorer</h2></div>
      <div class="card-body grid">
        <label><input type="checkbox" id="gOvr"> Tillåt manuell överstyrning av säkerhetsfaktorer (γM, γR)</label>
        <div class="row">
          <div>
            <label for="gM">γM</label>
            <input id="gM" type="text" value="1.5" disabled>
          </div>
          <div>
            <label for="gR">γR</label>
            <input id="gR" type="text" value="2.4" disabled>
          </div>
        </div>
        <div class="small">Standard: γM=1,5 och γR=2,4. Utan överstyrning används exakt dessa värden.</div>
      </div>
    </div>

  </div>

<script>
// ----------------------------
// Materialdatabas (P235GH)
// ----------------------------
const DB = {
  "EN 10216-2": {
    P235GH: {
      Rm_RT: 360, Re_RT: 235, note: "Gäller för godstjocklek t ≤ 60 mm",
      temp: [
        {T:100, Re:198},{T:150, Re:187},{T:200, Re:170},{T:250, Re:150},
        {T:300, Re:132},{T:350, Re:120},{T:400, Re:112},{T:450, Re:108}
      ]
    }
  },
  "EN 10217-2": {
    P235GH: {
      Rm_RT: 360, Re_RT: 235, note: "Gäller för godstjocklek t ≤ 16 mm",
      temp: [
        {T:100, Re:198},{T:150, Re:187},{T:200, Re:170},{T:250, Re:150},
        {T:300, Re:132},{T:350, Re:120},{T:400, Re:112}
      ]
    }
  },
  "EN 10217-5": {
    P235GH: {
      Rm_RT: 360, Re_RT: 235, note: "Gäller för godstjocklek t ≤ 40 mm",
      temp: [
        {T:100, Re:198},{T:150, Re:187},{T:200, Re:170},{T:250, Re:150},
        {T:300, Re:132},{T:350, Re:120},{T:400, Re:112}
      ]
    }
  }
};

function num(v){ return (String(v).trim()===""? NaN : Number(v)); }

// Re(T) med detaljer och giltighet enligt reglerna
function getReTWithDetail(dataset, T, ReRT){
  if (T==null || isNaN(T)) return { value:null, detail:"Temperatur saknas", valid:false };
  const pts = Array.isArray(dataset) ? dataset.slice().sort((a,b)=>a.T-b.T) : [];
  if (pts.length===0){
    return T<=50 ? { value:ReRT, detail:"Använde Re,RT vid 20 °C", valid:true }
                 : { value:null, detail:"Inga tabellvärden för temperatur", valid:false };
  }
  if (T<=50) return { value:ReRT, detail:"T ≤ 50 °C → Re,RT vid 20 °C", valid:true };

  // Hämta Re(100)
  let Re100 = null;
  const i100 = pts.findIndex(p=>p.T===100);
  if (i100>=0) Re100 = pts[i100].Re;
  else{
    for (let i=0;i<pts.length-1;i++){
      const a=pts[i], b=pts[i+1];
      if (100>=a.T && 100<=b.T){ Re100 = a.Re + (b.Re-a.Re)*((100-a.T)/(b.T-a.T)); break; }
    }
  }

  if (T<100 && Re100!=null){
    const T1=20, R1=ReRT, T2=100, R2=Re100;
    const val = R1 + (R2-R1)*((T-T1)/(T2-T1));
    return { value:val, detail:`Interpolerat mellan (20 °C, ${R1} MPa) och (100 °C, ${R2} MPa)`, valid:true };
  }

  // Tak-kontroll
  const Tmax = pts[pts.length-1].T;
  if (T > Tmax) return { value:null, detail:`Temperatur ${T} °C är över tabellens max ${Tmax} °C`, valid:false };

  // Interpolation ≥100
  for (let i=0;i<pts.length-1;i++){
    const a=pts[i], b=pts[i+1];
    if (T===a.T) return { value:a.Re, detail:`Tabellvärde vid ${a.T} °C`, valid:true };
    if (T>a.T && T<b.T){
      const val = a.Re + (b.Re-a.Re)*((T-a.T)/(b.T-a.T));
      return { value:val, detail:`Interpolerat mellan (${a.T} °C, ${a.Re} MPa) och (${b.T} °C, ${b.Re} MPa)`, valid:true };
    }
  }
  const last = pts[pts.length-1];
  if (T===last.T) return { value:last.Re, detail:`Tabellvärde vid ${last.T} °C`, valid:true };
  return { value:null, detail:"Kunde inte bestämma Re(T)", valid:false };
}

const els = {
  pressure: document.getElementById('pressure'),
  Do: document.getElementById('Do'),
  std: document.getElementById('std'),
  mat: document.getElementById('mat'),
  T: document.getElementById('T'),
  z: document.getElementById('z'),
  c: document.getElementById('c'),
  a: document.getElementById('a'),
  ovr: document.getElementById('ovr'),
  ovrRow: document.getElementById('ovrRow'),
  ReT: document.getElementById('ReT'),
  RmRT: document.getElementById('RmRT'),
  gOvr: document.getElementById('gOvr'),
  gM: document.getElementById('gM'),
  gR: document.getElementById('gR'),
  result: document.getElementById('result')
};

function render(){
  const db = DB[els.std.value] && DB[els.std.value][els.mat.value];
  if(!db){
    els.result.innerHTML = '<div class="error-banner">Okänt material/standard.</div>';
    return;
  }

  const P_bar = num(els.pressure.value);
  const Do = num(els.Do.value);
  const T = num(els.T.value);
  const z = num(els.z.value);
  const c_mm = num(els.c.value);
  const a_pct = num(els.a.value);

  // Re(T)/Rm,RT
  const reInfo = getReTWithDetail(db.temp, T, db.Re_RT);
  const reValid = reInfo.valid;
  const ReT_used = els.ovr.checked && !isNaN(num(els.ReT.value)) ? num(els.ReT.value) : (reInfo.value ?? NaN);
  const RmRT_used = els.ovr.checked && !isNaN(num(els.RmRT.value)) ? num(els.RmRT.value) : (db.Rm_RT ?? NaN);

  // Säkerhetsfaktorer
  const gM = els.gOvr.checked ? num(els.gM.value) : 1.5;
  const gR = els.gOvr.checked ? num(els.gR.value) : 2.4;

  // Validering
  if (!reValid){
    els.result.innerHTML = `<div class="error-banner">${reInfo.detail}. Ingen beräkning utförs.</div>`;
    return;
  }
  if ([P_bar, Do, z, gM, gR, ReT_used, RmRT_used].some(v=>!isFinite(v))){
    els.result.innerHTML = `<div class="small">Fyll i alla nödvändiga fält med giltiga värden. <span class="warn">${reInfo.detail||""}</span></div>`;
    return;
  }
  if (Do<=0 || z<=0 || z>1 || gM<=0 || gR<=0 || ReT_used<=0 || RmRT_used<=0){
    els.result.innerHTML = `<div class="small warn">Kontrollera att alla värden är rimliga (Do>0, 0<z≤1, γ>0, Re/Rm>0).</div>`;
    return;
  }

  const P_MPa = P_bar * 0.1; // 1 bar = 0.1 MPa
  const f_allow = Math.min(ReT_used / gM, RmRT_used / gR);
  const t0_mm = (P_MPa * Do) / (2 * f_allow * z + P_MPa);
  const c = isFinite(c_mm) && c_mm>0 ? c_mm : 0;
  const a = isFinite(a_pct) && a_pct>0 ? a_pct : 0;
  const t_req_mm = (t0_mm + c) / (1 - a/100);

  els.result.innerHTML = `
    <div>
      <span class="pill">${els.std.value}</span>
      <span class="pill">${els.mat.value}</span>
      <span class="pill">T = ${isNaN(T)?"NA":T} °C</span>
    </div>
    <div>
      <div class="small">Tillåten spänning f</div>
      <div class="kpi">${f_allow.toFixed(2)} <span class="small">MPa</span></div>
      <div class="small">f = min(Re(T)/γM, Rm,RT/γR) – använder γM=${gM.toFixed(2)}, γR=${gR.toFixed(2)}</div>
      <div class="small">${reInfo.detail}</div>
      ${db.note ? `<div class="small">${db.note}</div>` : ""}
    </div>
    <div class="row">
      <div>
        <div class="small">Tjocklek utan tillägg t0</div>
        <div class="kpi">${t0_mm.toFixed(3)} <span class="small">mm</span></div>
        <div class="small">t0 = (P·Do) / (2·f·z + P)</div>
      </div>
      <div>
        <div class="small">Erforderlig tjocklek t<sub>req</sub></div>
        <div class="kpi">${t_req_mm.toFixed(3)} <span class="small">mm</span></div>
        <div class="small">t<sub>req</sub> = (t0 + c) / (1 − α/100)</div>
      </div>
    </div>
    <div class="row">
      <div>
        <div class="small">Härlett Re(T)</div>
        <div class="kpi">${ReT_used.toFixed(1)} <span class="small">MPa</span></div>
      </div>
      <div>
        <div class="small">Rm,RT</div>
        <div class="kpi">${RmRT_used.toFixed(1)} <span class="small">MPa</span></div>
      </div>
    </div>
  `;
}

// events
['input','change'].forEach(evt=>{
  [
    'pressure','Do','std','mat','T','z','c','a','ReT','RmRT','gM','gR'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener(evt, render);
  });
});

document.getElementById('ovr').addEventListener('change', e=>{
  els.ovrRow.style.display = e.target.checked ? 'grid' : 'none';
  render();
});
document.getElementById('gOvr').addEventListener('change', e=>{
  els.gM.disabled = !e.target.checked;
  els.gR.disabled = !e.target.checked;
  render();
});

// initial render
render();
</script>
</body>
</html>

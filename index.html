<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>EN 13480-3 – Godstjocklek för rör (material + delning)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EN13480 Rör">
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg1:#e6f3ff; --bg2:#f7fbff;
      --card:#ffffff; --text:#0a0f1a; --muted:#334155; --line:#cfe0f3; --accent:#0ea5e9;
      --ok:#166534; --warn:#b45309; --err:#b91c1c;
      --shadow: 0 6px 24px rgba(3,23,53,.06);
      --shadow-sm: 0 2px 10px rgba(3,23,53,.05);
      --input-bg:#fff;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, #f0f8ff 30%, transparent 70%),
                  radial-gradient(900px 500px at 120% 10%, #eaf6ff 20%, transparent 70%),
                  linear-gradient(180deg,var(--bg1),var(--bg2) 140px);
      min-height:100vh;
      padding-bottom: calc(var(--safe-bottom) + 8px);
    }
    .container{max-width:1150px;margin:0 auto;padding:20px 24px 28px}
    header.page{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px;padding-top:calc(var(--safe-top) + 10px)}
    h1{margin:6px 0 0;font-size:28px;letter-spacing:.2px;font-weight:800}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .card-header{padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#f0f7ff,#fff)}
    .card-header h2{margin:0;font-size:18px;font-weight:700}
    .card-body{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;font-weight:700}
    input[type="text"], select{
      width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:10px;background:var(--input-bg);color:var(--text);
      font-size:14px; font-weight:600; box-shadow:inset 0 1px 0 rgba(255,255,255,.45);
    }
    input[disabled], select[disabled]{background:#f1f5f9;color:#475569}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .small{font-size:12px;color:var(--muted);font-weight:600}
    .pill{display:inline-block;background:#e7f1ff;color:#1e293b;padding:3px 9px;border-radius:999px;font-size:12px;margin-right:6px;border:1px solid #cfe0f3;font-weight:700}
    .kpi{font-size:22px;font-weight:800}
    .warn{color:var(--warn)} .err{color:var(--err)} .ok{color:var(--ok)}
    .spacer{height:8px}
    .note{padding:10px 12px;border-radius:12px;border:1px dashed var(--line);background:#f7fbff}
    .error-banner{padding:10px 12px;border:1px solid #fecaca;background:#fff1f2;color:#991b1b;border-radius:12px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;color:var(--muted);gap:12px}
    .btn{
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 14px;border:1px solid var(--line);border-radius:12px;
      background:#ffffff; color:#0b1324; cursor:pointer; box-shadow:var(--shadow-sm);
      -webkit-tap-highlight-color: transparent;
      font-weight:700;
    }
    .btn svg{width:16px;height:16px}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:#0ea5e9;color:white;border-color:#0891b2}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .modal-backdrop{position:fixed;inset:0;background:rgba(8,15,30,.45);display:none;align-items:flex-start;justify-content:center;padding:20px;z-index:50}
    .modal{width:min(920px,95vw);margin-top:6vh;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#f0f7ff,#fff)}
    .modal header h3{margin:0;font-size:18px}
    .modal .body{padding:16px}
    .modal .footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px}
    .temp-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:640px){ .temp-grid{grid-template-columns:repeat(2,1fr);} }
    .link{color:#0ea5e9;cursor:pointer;text-decoration:underline}
    pre.json{white-space:pre-wrap;background:#f7fbff;border:1px solid var(--line);padding:8px 10px;border-radius:10px}
    @media print { .footer, .no-print, .toolbar .btn{ display:none !important } }
  </style>
</head>
<body>
  <div class="container">
    <header class="page">
      <div><h1>EN 13480-3 – Godstjocklek för rör</h1></div>
      <div class="toolbar no-print">
        <button class="btn" id="addMatBtn">Lägg till material</button>
        <button class="btn" id="exportJsonBtn">Exportera material (JSON)</button>
        <button class="btn" id="importJsonBtn">Importera material (JSON)</button>
      </div>
    </header>

    <div class="grid grid-2">
      <div class="card">
        <div class="card-header"><h2>Indata</h2></div>
        <div class="card-body grid">
          <div class="row">
            <div>
              <label for="pressure">Designtryck (bar)</label>
              <input id="pressure" type="text" placeholder="t.ex. 40">
            </div>
            <div>
              <label for="Do">Ytterdiameter Do (mm)</label>
              <input id="Do" type="text" placeholder="t.ex. 219.1">
            </div>
          </div>

          <div class="row">
            <div>
              <label for="std">Materialstandard</label>
              <select id="std"></select>
            </div>
            <div>
              <label for="mat">Material</label>
              <select id="mat"></select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="T">Beräkningstemperatur T (°C)</label>
              <input id="T" type="text" placeholder="t.ex. 150" value="150">
            </div>
            <div>
              <label for="z">Svetsfaktor z (0–1)</label>
              <input id="z" type="text" placeholder="t.ex. 1.0" value="1.0">
            </div>
          </div>

          <div class="row">
            <div>
              <label for="c">Korrosionstillägg c (mm)</label>
              <input id="c" type="text" placeholder="0" value="0">
            </div>
            <div>
              <label for="a">Minus-tolerans α (%)</label>
              <input id="a" type="text" placeholder="0" value="0">
            </div>
          </div>

          <div class="note">
            <label><input type="checkbox" id="ovr"> Visa & överstyr Re(T) och Rm,RT</label>
            <div class="row" id="ovrRow" style="display:none;margin-top:8px">
              <div>
                <label for="ReT">Re(T) manuell (MPa)</label>
                <input id="ReT" type="text" placeholder="t.ex. 205">
              </div>
              <div>
                <label for="RmRT">Rm,RT manuell (MPa)</label>
                <input id="RmRT" type="text" placeholder="t.ex. 360">
              </div>
            </div>
          </div>

          <div class="note" style="margin-top:8px">
            <label><input type="checkbox" id="gOvr"> Visa & överstyr säkerhetsfaktorer (γM, γR). Standard: γM=1,5 och γR=2,4</label>
            <div class="row" id="gammaRow" style="display:none;margin-top:8px">
              <div>
                <label for="gM">γM</label>
                <input id="gM" type="text" value="1.5">
              </div>
              <div>
                <label for="gR">γR</label>
                <input id="gR" type="text" value="2.4">
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Resultat</h2></div>
        <div class="card-body grid" id="result">
          <div class="small">Fyll i alla nödvändiga fält med giltiga värden.</div>
        </div>
      </div>
    </div>

    <div class="spacer"></div>
    <footer class="footer">
      <div>skapad av JL</div>
      <div class="toolbar">
        <button class="btn" id="exportBtn" title="Skriv ut / spara som PDF" aria-label="Exportera till PDF">
          <svg viewBox="0 0 24 24" fill="none"><path d="M7 9V3h10v6M6 14H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1M7 14h10v7H7v-7Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Exportera till PDF
        </button>
      </div>
    </footer>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3>Lägg till material</h3>
        <button class="btn" id="closeModalBtn">Stäng</button>
      </header>
      <div class="body">
        <div class="row-3">
          <div>
            <label>Materialstandard</label>
            <input type="text" id="mStd" placeholder="t.ex. EN 10216-2">
            <div class="small">Skriv befintlig eller ny standard.</div>
          </div>
          <div>
            <label>Materialnamn</label>
            <input type="text" id="mName" placeholder="t.ex. P265GH">
          </div>
          <div>
            <label>Rm,RT (MPa)</label>
            <input type="text" id="mRmRT" placeholder="t.ex. 410">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Re,RT (MPa) – vid 20 °C</label>
            <input type="text" id="mReRT" placeholder="t.ex. 265">
          </div>
          <div class="small" style="align-self:end">Lämna tomt om okänt.</div>
        </div>
        <div style="margin:12px 0 6px" class="small">Re(T) vid förhöjd temperatur (lämna tomt där värden saknas):</div>
        <div class="temp-grid" id="tempGrid"></div>
        <div class="small" style="margin-top:8px">Temperaturpunkter: 100, 150, 200, 250, 300, 350, 400, 450 °C</div>
      </div>
      <div class="footer">
        <button class="btn" id="resetFormBtn">Rensa</button>
        <button class="btn primary" id="saveMaterialBtn">Spara material</button>
      </div>
    </div>
  </div>

<script>
const TEMP_POINTS = [100,150,200,250,300,350,400,450];

const DEFAULT_DB = {
  "EN 10216-2": {
    P235GH: {
      Rm_RT: 360, Re_RT: 235, note: "Gäller för godstjocklek t ≤ 60 mm",
      temp: [{T:100, Re:198},{T:150, Re:187},{T:200, Re:170},{T:250, Re:150},{T:300, Re:132},{T:350, Re:120},{T:400, Re:112},{T:450, Re:108}]
    }
  },
  "EN 10217-2": {
    P235GH: {
      Rm_RT: 360, Re_RT: 235, note: "Gäller för godstjocklek t ≤ 16 mm",
      temp: [{T:100, Re:198},{T:150, Re:187},{T:200, Re:170},{T:250, Re:150},{T:300, Re:132},{T:350, Re:120},{T:400, Re:112}]
    }
  },
  "EN 10217-5": {
    P235GH: {
      Rm_RT: 360, Re_RT: 235, note: "Gäller för godstjocklek t ≤ 40 mm",
      temp: [{T:100, Re:198},{T:150, Re:187},{T:200, Re:170},{T:250, Re:150},{T:300, Re:132},{T:350, Re:120},{T:400, Re:112}]
    }
  }
};

function loadDB(){
  try{ const s = localStorage.getItem("EN13480_DB"); if (s) return JSON.parse(s); }catch(e){}
  return JSON.parse(JSON.stringify(DEFAULT_DB));
}
function saveDB(db){ try{ localStorage.setItem("EN13480_DB", JSON.stringify(db)); }catch(e){ alert("Kunde inte spara till localStorage."); }}

// --- Merge helpers ---
function mergeDB(base, incoming, strategy){
  // strategy: 'keep' (keep existing), 'replace' (use incoming on conflict)
  const out = JSON.parse(JSON.stringify(base || {}));
  for (const std of Object.keys(incoming||{})){
    if (!out[std]){ out[std] = JSON.parse(JSON.stringify(incoming[std])); continue; }
    for (const mat of Object.keys(incoming[std])){
      if (!out[std][mat]){
        out[std][mat] = JSON.parse(JSON.stringify(incoming[std][mat]));
      } else {
        if (strategy === 'replace'){
          out[std][mat] = JSON.parse(JSON.stringify(incoming[std][mat]));
        } else {
          // keep existing, but merge temp points if missing
          const existing = out[std][mat];
          const inc = incoming[std][mat];
          existing.Rm_RT = existing.Rm_RT ?? inc.Rm_RT;
          existing.Re_RT = existing.Re_RT ?? inc.Re_RT;
          const tempMap = {};
          (existing.temp||[]).forEach(p=>tempMap[p.T]=p.Re);
          (inc.temp||[]).forEach(p=>{ if (tempMap[p.T]==null) tempMap[p.T]=p.Re; });
          existing.temp = Object.keys(tempMap).map(T=>({T:Number(T), Re:tempMap[T]})).sort((a,b)=>a.T-b.T);
          existing.note = existing.note || inc.note || "";
        }
      }
    }
  }
  return out;
}

let DB = loadDB();

const els = {
  std: document.getElementById('std'),
  mat: document.getElementById('mat'),
  pressure: document.getElementById('pressure'),
  Do: document.getElementById('Do'),
  T: document.getElementById('T'),
  z: document.getElementById('z'),
  c: document.getElementById('c'),
  a: document.getElementById('a'),
  ovr: document.getElementById('ovr'),
  ovrRow: document.getElementById('ovrRow'),
  ReT: document.getElementById('ReT'),
  RmRT: document.getElementById('RmRT'),
  gOvr: document.getElementById('gOvr'),
  gM: document.getElementById('gM'),
  gR: document.getElementById('gR'),
  gammaRow: document.getElementById('gammaRow'),
  result: document.getElementById('result'),
  exportBtn: document.getElementById('exportBtn'),
  addMatBtn: document.getElementById('addMatBtn'),
  exportJsonBtn: document.getElementById('exportJsonBtn'),
  importJsonBtn: document.getElementById('importJsonBtn'),
  modalBackdrop: document.getElementById('modalBackdrop'),
  closeModalBtn: document.getElementById('closeModalBtn'),
  saveMaterialBtn: document.getElementById('saveMaterialBtn'),
  resetFormBtn: document.getElementById('resetFormBtn'),
  mStd: document.getElementById('mStd'),
  mName: document.getElementById('mName'),
  mRmRT: document.getElementById('mRmRT'),
  mReRT: document.getElementById('mReRT'),
  tempGrid: document.getElementById('tempGrid')
};

TEMP_POINTS.forEach(tp => {
  const wrap = document.createElement('div');
  const lab = document.createElement('label'); lab.textContent = `Re @ ${tp} °C (MPa)`;
  const inp = document.createElement('input'); inp.type = 'text'; inp.dataset.temp = String(tp); inp.placeholder = '—';
  wrap.appendChild(lab); wrap.appendChild(inp);
  els.tempGrid.appendChild(wrap);
});

function rebuildStdOptions(){
  const stds = Object.keys(DB).sort();
  els.std.innerHTML = stds.map(s=>`<option value="${s}">${s}</option>`).join('');
  if (!DB[els.std.value]) els.std.value = stds[0] || "";
  rebuildMatOptions();
}
function rebuildMatOptions(){
  const mats = DB[els.std.value] ? Object.keys(DB[els.std.value]).sort() : [];
  els.mat.innerHTML = mats.map(m=>`<option value="${m}">${m}</option>`).join('');
  if (!DB[els.std.value][els.mat.value]) els.mat.value = mats[0] || "";
  render();
}

function num(v){ return (String(v).trim()===""? NaN : Number(v)); }

function getReTWithDetail(dataset, T, ReRT){
  if (T==null || isNaN(T)) return { value:null, detail:"Temperatur saknas", valid:false };
  const pts = Array.isArray(dataset) ? dataset.slice().sort((a,b)=>a.T-b.T) : [];
  if (pts.length===0){
    return T<=50 ? { value:ReRT, detail:"Använde Re,RT vid 20 °C", valid:true }
                 : { value:null, detail:"Inga tabellvärden för temperatur", valid:false };
  }
  if (T<=50) return { value:ReRT, detail:"T ≤ 50 °C → Re,RT vid 20 °C", valid:true };
  let Re100 = null;
  const i100 = pts.findIndex(p=>p.T===100);
  if (i100>=0) Re100 = pts[i100].Re;
  else{
    for (let i=0;i<pts.length-1;i++){
      const a=pts[i], b=pts[i+1];
      if (100>=a.T && 100<=b.T){ Re100 = a.Re + (b.Re-a.Re)*((100-a.T)/(b.T-a.T)); break; }
    }
  }
  if (T<100 && Re100!=null){
    const T1=20, R1=ReRT, T2=100, R2=Re100;
    const val = R1 + (R2-R1)*((T-T1)/(T2-T1));
    return { value:val, detail:`Interpolerat mellan (20 °C, ${R1} MPa) och (100 °C, ${R2} MPa)`, valid:true };
  }
  const Tmax = pts[pts.length-1].T;
  if (T > Tmax) return { value:null, detail:`Temperatur ${T} °C är över tabellens max ${Tmax} °C`, valid:false };
  for (let i=0;i<pts.length-1;i++){
    const a=pts[i], b=pts[i+1];
    if (T===a.T) return { value:a.Re, detail:`Tabellvärde vid ${a.T} °C`, valid:true };
    if (T>a.T && T<b.T){
      const val = a.Re + (b.Re-a.Re)*((T-a.T)/(b.T-a.T));
      return { value:val, detail:`Interpolerat mellan (${a.T} °C, ${a.Re} MPa) och (${b.T} °C, ${b.Re} MPa)`, valid:true };
    }
  }
  const last = pts[pts.length-1];
  if (T===last.T) return { value:last.Re, detail:`Tabellvärde vid ${last.T} °C`, valid:true };
  return { value:null, detail:"Kunde inte bestämma Re(T)", valid:false };
}

function render(){
  const db = DB[els.std.value] && DB[els.std.value][els.mat.value];
  if(!db){
    els.result.innerHTML = '<div class="error-banner">Okänt material/standard.</div>';
    return;
  }

  const P_bar = num(els.pressure.value);
  const Do = num(els.Do.value);
  const T = num(els.T.value);
  const z = num(els.z.value);
  const c_mm = num(els.c.value);
  const a_pct = num(els.a.value);

  const reInfo = getReTWithDetail(db.temp || [], T, db.Re_RT);
  const reValid = reInfo.valid;
  const ReT_used = els.ovr.checked && !isNaN(num(els.ReT.value)) ? num(els.ReT.value) : (reInfo.value ?? NaN);
  const RmRT_used = els.ovr.checked && !isNaN(num(els.RmRT.value)) ? num(els.RmRT.value) : (db.Rm_RT ?? NaN);

  const gM = els.gOvr.checked ? num(els.gM.value) : 1.5;
  const gR = els.gOvr.checked ? num(els.gR.value) : 2.4;

  if (!reValid){
    els.result.innerHTML = `<div class="error-banner">${reInfo.detail}. Ingen beräkning utförs.</div>`;
    return;
  }
  if ([P_bar, Do, z, gM, gR, ReT_used, RmRT_used].some(v=>!isFinite(v))){
    els.result.innerHTML = `<div class="small">Fyll i alla nödvändiga fält med giltiga värden.</div>`;
    return;
  }
  if (Do<=0 || z<=0 || z>1 || gM<=0 || gR<=0 || ReT_used<=0 || RmRT_used<=0){
    els.result.innerHTML = `<div class="small warn">Kontrollera att alla värden är rimliga (Do>0, 0<z≤1, γ>0, Re/Rm>0).</div>`;
    return;
  }

  const P_MPa = P_bar * 0.1;
  const f_allow = Math.min(ReT_used / gM, RmRT_used / gR);
  const t0_mm = (P_MPa * Do) / (2 * f_allow * z + P_MPa);
  const c = isFinite(c_mm) && c_mm>0 ? c_mm : 0;
  const a = isFinite(a_pct) && a_pct>0 ? a_pct : 0;
  const t_req_mm = (t0_mm + c) / (1 - a/100);

  els.result.innerHTML = `
    <div>
      <span class="pill">${els.std.value}</span>
      <span class="pill">${els.mat.value}</span>
      <span class="pill">T = ${isNaN(T)?"NA":T} °C</span>
    </div>
    <div class="row">
      <div>
        <div class="small">Erforderlig tjocklek t<sub>req</sub></div>
        <div class="kpi">${t_req_mm.toFixed(3)} <span class="small">mm</span></div>
        <div class="small">t<sub>req</sub> = (t0 + c) / (1 − α/100)</div>
      </div>
      <div>
        <div class="small">Tjocklek utan tillägg t0</div>
        <div class="kpi">${t0_mm.toFixed(3)} <span class="small">mm</span></div>
        <div class="small">t0 = (P·Do) / (2·f·z + P)</div>
      </div>
    </div>
    <div>
      <div class="small">Tillåten spänning f</div>
      <div class="kpi">${f_allow.toFixed(2)} <span class="small">MPa</span></div>
      <div class="small">f = min(Re(T)/γM, Rm,RT/γR)</div>
      <div class="small">${reInfo.detail}</div>
      ${db.note ? `<div class="small">${db.note}</div>` : ""}
    </div>
    <div class="row">
      <div>
        <div class="small">Härlett Re(T)</div>
        <div class="kpi">${ReT_used.toFixed(1)} <span class="small">MPa</span></div>
      </div>
      <div>
        <div class="small">Rm,RT</div>
        <div class="kpi">${RmRT_used.toFixed(1)} <span class="small">MPa</span></div>
      </div>
    </div>
  `;
}

// UI wiring
['input','change'].forEach(evt=>{
  ['pressure','Do','std','mat','T','z','c','a','ReT','RmRT','gM','gR'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener(evt, render);
  });
});
document.getElementById('ovr').addEventListener('change', e=>{ document.getElementById('ovrRow').style.display = e.target.checked ? 'grid' : 'none'; render(); });
document.getElementById('gOvr').addEventListener('change', e=>{ document.getElementById('gammaRow').style.display = e.target.checked ? 'grid' : 'none'; render(); });
document.getElementById('exportBtn').addEventListener('click', ()=>{ window.print(); });

// Modal controls
function openModal(){ els.modalBackdrop.style.display='flex'; }
function closeModal(){ els.modalBackdrop.style.display='none'; }
document.getElementById('addMatBtn').addEventListener('click', openModal);
document.getElementById('closeModalBtn').addEventListener('click', closeModal);
document.getElementById('resetFormBtn').addEventListener('click', ()=>{
  els.mStd.value=""; els.mName.value=""; els.mRmRT.value=""; els.mReRT.value="";
  els.tempGrid.querySelectorAll('input').forEach(i=>i.value="");
});

// Export helpers
function downloadDB(db, filename){
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  downloadDB(DB, `material-database-${ts}.json`);
});

// Save material + auto-export
document.getElementById('saveMaterialBtn').addEventListener('click', ()=>{
  const std = els.mStd.value.trim();
  const name = els.mName.value.trim();
  const RmRT = Number(els.mRmRT.value);
  const ReRT = Number(els.mReRT.value);
  if (!std || !name){ alert("Ange materialstandard och materialnamn."); return; }
  if (!isFinite(RmRT) || !isFinite(ReRT)){ alert("Ange numeriska värden för Rm,RT och Re,RT (MPa)."); return; }
  const temps = [];
  els.tempGrid.querySelectorAll('input').forEach(inp=>{
    const v = inp.value.trim();
    if (v!==""){
      const numv = Number(v);
      if (isFinite(numv)) temps.push({T:Number(inp.dataset.temp), Re:numv});
    }
  });
  temps.sort((a,b)=>a.T-b.T);
  if (!DB[std]) DB[std] = {};
  DB[std][name] = { Rm_RT: RmRT, Re_RT: ReRT, note: "", temp: temps };
  saveDB(DB);
  rebuildStdOptions();
  els.std.value = std;
  rebuildMatOptions();
  els.mat.value = name;
  closeModal();
  render();
  // Auto-export backup
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  downloadDB(DB, `material-database-${ts}.json`);
  alert("Material sparat och säkerhetskopierat (JSON nedladdad).");
});

// Import (merge by default; optional replace)
document.getElementById('importJsonBtn').addEventListener('click', ()=>{
  const doReplace = confirm("Vill du ERSÄTTA hela databasen? Välj Avbryt för att SAMMANFOGA (rekommenderas).");
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='.json,application/json';
  inp.onchange = () => {
    if (!inp.files || !inp.files[0]) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(String(reader.result));
        if (typeof obj !== 'object' || Array.isArray(obj)) throw new Error("Fel format");
        if (doReplace){
          DB = obj;
        } else {
          DB = mergeDB(DB, obj, 'keep'); // keep existing on conflict, fill in missing temps/fields
        }
        saveDB(DB); rebuildStdOptions(); render();
        alert(doReplace ? "Materialdatabas ersatt." : "Materialdatabas sammanslagen (merge).");
      }catch(e){ alert("Kunde inte läsa JSON: " + e.message); }
    };
    reader.readAsText(inp.files[0]);
  };
  inp.click();
});

// Central materials.json loader (merged at startup if present)
async function tryLoadCentral(){
  try{
    const res = await fetch('materials.json', {cache:'no-store'});
    if (!res.ok) return;
    const central = await res.json();
    if (typeof central === 'object' && !Array.isArray(central)){
      DB = mergeDB(DB, central, 'keep'); // keep local on conflict
      saveDB(DB);
    }
  }catch(e){ /* offline eller saknas – ignorera */ }
}

function rebuildStdOptions(){ // re-declare to ensure hoist correct after tryLoadCentral addition
  const stds = Object.keys(DB).sort();
  els.std.innerHTML = stds.map(s=>`<option value="${s}">${s}</option>`).join('');
  if (!DB[els.std.value]) els.std.value = stds[0] || "";
  rebuildMatOptions();
}
function rebuildMatOptions(){
  const mats = DB[els.std.value] ? Object.keys(DB[els.std.value]).sort() : [];
  els.mat.innerHTML = mats.map(m=>`<option value="${m}">${m}</option>`).join('');
  if (!DB[els.std.value][els.mat.value]) els.mat.value = mats[0] || "";
  render();
}

// Init
(async () => {
  await tryLoadCentral();
  rebuildStdOptions();
  render();
})();
</script>
</body>
</html>
